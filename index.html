<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portfolio Tracker (Browser-only)</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0D3643;
      --panel:#123F4F;
      --panel2:#0F3543;
      --text:#E6F1F3;
      --muted:#9FB7BF;
      --line:rgba(255,255,255,.10);
      --accent:#F2A65A;
      --accent2:#FFB703;
      --good:#39d98a;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --chip:#0F3040;
      --focus:rgba(242,166,90,.25);
      --shadow: 0 10px 25px rgba(0,0,0,.25);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: var(--bg);
      color:var(--text);
      font-family:var(--sans);
      line-height:1.35;
    }

    header{
      position:sticky; top:0; z-index:10;
      background: rgba(13,54,67,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }

    .wrap{
      max-width: 1280px;
      margin: 0 auto;
      padding: 14px 14px 20px;
    }
    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .title{
      display:flex; align-items:baseline; gap:10px; flex-wrap:wrap;
    }
    h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .3px;
    }
    .sub{
      color:var(--muted);
      font-size: 12px;
    }
    .btnrow{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    button, select, input{ font:inherit; color:var(--text); }
    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      padding:8px 10px;
      border-radius: 12px;
      cursor:pointer;
      box-shadow: var(--shadow);
      transition: transform .05s ease, border-color .2s ease, background .2s ease;
      white-space:nowrap;
    }
    button:hover{ border-color: rgba(242,166,90,.65); }
    button:active{ transform: translateY(1px); }
    .primary{
      border-color: rgba(242,166,90,.65);
      background: rgba(242,166,90,.14);
    }
    .danger{
      border-color: rgba(255,107,107,.55);
      background: rgba(255,107,107,.10);
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      background: var(--chip);
      border:1px solid var(--line);
      border-radius: 12px;
      box-shadow: var(--shadow);
      flex-wrap:wrap;
    }
    .chip label{
      color:var(--muted);
      font-size:12px;
    }
    .chip input, .chip select{
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      padding:6px 8px;
      border-radius:10px;
      outline:none;
      min-width: 120px;
    }
    .chip input:focus, .chip select:focus{
      box-shadow: 0 0 0 4px var(--focus);
      border-color: rgba(242,166,90,.7);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardhead{
      padding: 12px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid var(--line);
    }
    .cardhead h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .cardhead .hint{
      color:var(--muted);
      font-size: 12px;
      margin-top: 3px;
    }
    .cardbody{ padding: 12px 14px 14px; }

    .statusline{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 6px;
      color:var(--muted);
      font-size: 12px;
    }
    .dot{
      width:8px; height:8px;
      border-radius:999px;
      background: var(--warn);
      display:inline-block;
      margin-right:6px;
    }
    .dot.good{ background: var(--good); }
    .dot.bad{ background: var(--bad); }

    .tablewrap{
      overflow:auto;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.10);
    }
    table{
      width: 100%;
      border-collapse: collapse;
      min-width: 1120px;
    }
    thead th{
      position:sticky; top:0;
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(8px);
      text-align:left;
      font-size: 12px;
      color: var(--muted);
      padding: 10px 10px;
      border-bottom: 1px solid var(--line);
      white-space:nowrap;
    }
    tbody td{
      padding: 8px 10px;
      border-bottom: 1px solid var(--line);
      vertical-align: middle;
      white-space:nowrap;
    }
    tbody tr:hover{ background: rgba(242,166,90,.06); }
    td input, td select{
      width: 100%;
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      padding: 7px 8px;
      border-radius: 10px;
      outline:none;
    }
    td input:focus, td select:focus{
      box-shadow: 0 0 0 4px var(--focus);
      border-color: rgba(242,166,90,.7);
    }
    .num{ text-align:right; font-family: var(--mono); }
    .small{ font-size: 12px; color: var(--muted); }
    .pill{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.10);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .pill .dot{ width:7px; height:7px; margin:0; }
    .right{ text-align:right; }
    .actions{ display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; }

    .tfoot{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .totals{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    @media (max-width: 720px){ .totals{ grid-template-columns: repeat(2, 1fr); } }
    .kpi{
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.10);
    }
    .kpi .label{ color:var(--muted); font-size:12px; }
    .kpi .value{ font-family:var(--mono); font-size: 16px; margin-top:4px; }

    .sidegrid{ display:grid; gap:14px; }

    .seg{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      justify-content:space-between;
    }
    .seg .leftseg{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .scenarioBtns{ display:flex; gap:8px; flex-wrap:wrap; }
    .scenarioBtns button{
      box-shadow:none;
      padding:7px 9px;
      border-radius: 999px;
      background: rgba(0,0,0,.10);
    }
    .scenarioBtns button.active{
      border-color: rgba(242,166,90,.8);
      background: rgba(242,166,90,.18);
    }
    .range{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input[type="range"]{ width: 240px; accent-color: var(--accent); }

    .note{ color:var(--muted); font-size:12px; margin-top: 10px; }
    .footer-note{ color: var(--muted); font-size: 12px; margin-top: 10px; }
    .linklike{ text-decoration: underline; cursor:pointer; }

    .colorbox{
      width: 44px;
      height: 32px;
      border-radius: 10px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.12);
      padding: 0;
      cursor:pointer;
    }

    .ratesbar{
      position: sticky;
      bottom: 0;
      z-index: 9;
      border-top: 1px solid var(--line);
      background: rgba(13,54,67,.92);
      backdrop-filter: blur(10px);
    }
    .rateswrap{
      max-width:1280px;
      margin:0 auto;
      padding: 10px 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .rateswrap .left{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .ratepill{
      font-family: var(--mono);
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.12);
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .ratepill span.label{
      font-family: var(--sans);
      color: var(--muted);
      font-size: 12px;
    }

    .modalbg{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      z-index: 50;
    }
    .modal{
      max-width: 900px;
      width: 100%;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .cardhead{ background: rgba(0,0,0,.06); }
    .modal .cardbody{ background: var(--panel2); }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>Portfolio Tracker</h1>
        <div class="sub">Runs entirely in your browser • Mobile-friendly • Saves to localStorage</div>
      </div>

      <div class="btnrow">
        <div class="chip">
          <label for="baseCcy">Base</label>
          <select id="baseCcy">
            <option value="USD" selected>USD</option>
            <option value="IDR">IDR</option>
            <option value="EUR">EUR</option>
            <option value="SGD">SGD</option>
            <option value="JPY">JPY</option>
            <option value="AUD">AUD</option>
            <option value="GBP">GBP</option>
          </select>
        </div>

        <div class="chip">
          <label for="otherCcy">Other</label>
          <select id="otherCcy">
            <option value="IDR" selected>IDR</option>
            <option value="SGD">SGD</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="JPY">JPY</option>
            <option value="AUD">AUD</option>
            <option value="GBP">GBP</option>
          </select>
        </div>

        <button id="refreshBtn" class="primary">Refresh prices</button>
        <button id="addRowBtn">Add row</button>
        <button id="scenariosBtn">Scenario rates</button>
        <button id="exportBtn">Export</button>
        <button id="importBtn">Import</button>
        <button id="resetBtn" class="danger">Reset</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <div class="cardhead">
        <div>
          <h2>Assets</h2>
          <div class="hint">For crypto: Source = “coingecko” and CoinGecko ID (bitcoin, tether). Gold: Source = gold_spot or manual.</div>
          <div class="statusline" id="statusLine">
            <span class="pill"><span class="dot" id="fxDot"></span><span id="fxStatus">FX: …</span></span>
            <span class="pill"><span class="dot" id="cgDot"></span><span id="cgStatus">CoinGecko: …</span></span>
            <span class="pill"><span class="dot" id="goldDot"></span><span id="goldStatus">Gold: …</span></span>
            <span class="pill"><span class="dot good"></span><span>Autosave: ON</span></span>
          </div>
        </div>
        <div class="actions">
          <button id="fillDefaultsBtn">Load your 10 defaults</button>
          <button id="downloadCsvBtn">Download CSV</button>
        </div>
      </div>

      <div class="cardbody">
        <div class="tablewrap">
          <table id="assetTable">
            <thead>
              <tr>
                <th style="min-width:220px;">Name</th>
                <th style="min-width:120px;">Category</th>
                <th style="min-width:110px;">Units</th>
                <th style="min-width:120px;">Unit</th>
                <th style="min-width:130px;">Amount currency</th>
                <th style="min-width:150px;">Source</th>
                <th style="min-width:160px;">Source ID / Ticker</th>
                <th style="min-width:140px;">Manual price (USD)</th>
                <th style="min-width:90px;">Color</th>
                <th style="min-width:160px;" class="right">Value (USD)</th>
                <th style="min-width:160px;" class="right">Value (IDR)</th>
                <th style="min-width:170px;" class="right">Value (Other)</th>
                <th style="min-width:120px;" class="right">Actions</th>
              </tr>
            </thead>
            <tbody id="assetTbody"></tbody>
          </table>
        </div>

        <div class="tfoot">
          <div class="totals">
            <div class="kpi">
              <div class="label">Total (USD)</div>
              <div class="value" id="totalUSD">$0.00</div>
            </div>
            <div class="kpi">
              <div class="label">Total (IDR)</div>
              <div class="value" id="totalIDR">Rp0</div>
            </div>
            <div class="kpi">
              <div class="label">Total (Other)</div>
              <div class="value" id="totalOther">0</div>
            </div>
            <div class="kpi">
              <div class="label">Last refresh</div>
              <div class="value" id="lastRefresh" style="font-size:13px; font-family:var(--sans); color:var(--muted);">—</div>
            </div>
          </div>

          <div class="note">
            Tip: You can set a unique color per asset (used in pie chart + legend). New rows auto-get a color.
          </div>
        </div>
      </div>
    </section>

    <aside class="sidegrid">
      <section class="card">
        <div class="cardhead">
          <div>
            <h2>Allocation</h2>
            <div class="hint">Pie chart updates with live prices (or manual prices).</div>
          </div>
          <div class="chip">
            <label for="allocYear">Year</label>
            <select id="allocYear"></select>
          </div>
        </div>
        <div class="cardbody">
          <canvas id="pieChart" height="220"></canvas>
          <div class="footer-note" id="allocNote"></div>
        </div>
      </section>

      <section class="card">
        <div class="cardhead">
          <div>
            <h2>Projection</h2>
            <div class="hint">Scenario compounding per year (asset-specific overrides supported).</div>
          </div>
          <div class="chip">
            <label for="horizonYears">Horizon</label>
            <select id="horizonYears"></select>
          </div>
        </div>
        <div class="cardbody">
          <div class="seg">
            <div class="leftseg scenarioBtns" id="scenarioBtns"></div>
            <div class="range">
              <span class="small">View year:</span>
              <input id="viewYearRange" type="range" min="0" max="10" step="1" value="0" />
              <span class="pill"><span class="dot good"></span><span id="viewYearLabel">0</span></span>
            </div>
          </div>

          <div style="margin-top:12px;">
            <canvas id="projChart" height="230"></canvas>
          </div>

          <div class="note">
            Edit default scenario rates via <span class="linklike" id="openScenarioLink">Scenario rates</span>.
          </div>
        </div>
      </section>
    </aside>
  </div>
</main>

<div class="ratesbar">
  <div class="rateswrap">
    <div class="left">
      <div class="ratepill"><span class="label">USD→IDR</span><span id="rateUsdIdr">—</span></div>
      <div class="ratepill"><span class="label">BTC→USD</span><span id="rateBtcUsd">—</span></div>
      <div class="ratepill"><span class="label">Gold→USD (oz)</span><span id="rateGoldUsdOz">—</span></div>
    </div>
    <div class="small" id="ratesUpdated">Rates updated: —</div>
  </div>
</div>

<input id="fileInput" type="file" accept="application/json" style="display:none" />

<div class="modalbg" id="scenarioModalBg" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="cardhead">
      <div>
        <h2>Scenario rates (annual %)</h2>
        <div class="hint">Defaults by category. Row-level overrides available via “Rates”.</div>
      </div>
      <div class="actions">
        <button id="scenarioCloseBtn">Close</button>
        <button id="scenarioSaveBtn" class="primary">Save</button>
      </div>
    </div>
    <div class="cardbody">
      <div class="tablewrap">
        <table style="min-width: 820px;">
          <thead>
            <tr>
              <th style="min-width:160px;">Scenario</th>
              <th>cash</th>
              <th>crypto</th>
              <th>gold</th>
              <th>stock</th>
              <th>other</th>
            </tr>
          </thead>
          <tbody id="scenarioDefaultsBody"></tbody>
        </table>
      </div>
      <div class="note">You can set gold/bitcoin opposite biases here (balancing behavior).</div>
    </div>
  </div>
</div>

<div class="modalbg" id="rowRatesModalBg" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="cardhead">
      <div>
        <h2 id="rowRatesTitle">Asset-specific rates</h2>
        <div class="hint">Overrides scenario defaults for this asset only.</div>
      </div>
      <div class="actions">
        <button id="rowRatesCloseBtn">Close</button>
        <button id="rowRatesSaveBtn" class="primary">Save</button>
      </div>
    </div>
    <div class="cardbody">
      <div class="tablewrap">
        <table style="min-width: 820px;">
          <thead>
            <tr>
              <th style="min-width:160px;">Scenario</th>
              <th style="min-width:220px;">Annual rate % (override)</th>
              <th>Default reference</th>
            </tr>
          </thead>
          <tbody id="rowRatesBody"></tbody>
        </table>
      </div>
      <div class="note">Leave blank to use defaults.</div>
    </div>
  </div>
</div>

<script>
(() => {
  const STORAGE_KEY = "portfolio_tracker_v2";

  const Categories = ["cash","crypto","gold","stock","other"];
  const Units = {
    cash: ["(currency)"],
    crypto: ["coin"],
    gold: ["gram","troy_oz"],
    stock: ["share"],
    other: ["unit"]
  };
  const PriceSource = ["manual","coingecko","gold_spot","none"];

  const ScenarioList = [
    { id:"steady", label:"Steady" },
    { id:"bull", label:"Bull" },
    { id:"mega", label:"Mega Bull" },
    { id:"bear", label:"Bear" },
    { id:"superbear", label:"Super Bear" },
    { id:"chaos", label:"Chaos" },
  ];

  let scenarioDefaults = {
    steady:    { cash:  2, crypto: 10, gold:  4, stock:  7, other:  3 },
    bull:      { cash:  2, crypto: 20, gold:  2, stock: 12, other:  6 },
    mega:      { cash:  2, crypto: 50, gold: -2, stock: 18, other:  8 },
    bear:      { cash:  2, crypto:-20, gold:  8, stock:-12, other: -5 },
    superbear: { cash:  2, crypto:-50, gold: 12, stock:-25, other:-12 },
    chaos:     { cash:  2, crypto: 15, gold:  6, stock:  5, other:  2 },
  };

  const PALETTE = [
    "#F2A65A","#FFB703","#8BE28B","#6AA7FF","#9B8BFF","#FF6B6B",
    "#2DD4BF","#22C55E","#E879F9","#60A5FA","#F87171","#A3E635",
    "#FB7185","#FBBF24","#34D399","#93C5FD","#C4B5FD","#FDBA74"
  ];

  const el = (id) => document.getElementById(id);

  function randId(){
    return Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2);
  }

  let state = {
    baseCcy: "USD",
    otherCcy: "IDR",
    rows: [],
    scenarioId: "steady",
    horizonYears: 5,
    viewYear: 0,
    fx: { base:"USD", rates: {}, at: null },
    pricesUSD: {},
    lastRefresh: null,
  };

  function pickNextColor(){
    const used = new Set((state.rows||[]).map(r => (r.color||"").toUpperCase()));
    for(const c of PALETTE){
      if(!used.has(c.toUpperCase())) return c;
    }
    return "#" + Math.floor(Math.random()*0xFFFFFF).toString(16).padStart(6,"0");
  }

  function mkRow(name, category, units, unit, amountCcy, source, sourceId, manualUsd, color){
    return {
      id: randId(),
      name,
      category,
      units: Number(units)||0,
      unit,
      amountCcy,
      source,
      sourceId,
      manualUsd: manualUsd === "" ? "" : Number(manualUsd),
      color: color || pickNextColor(),
      ratesOverride: {}
    };
  }

  const defaultRows = () => ([
    mkRow("Cash IDR",           "cash", 0, "(currency)", "IDR", "none", "", "", null),
    mkRow("Cash USD Bank A",    "cash", 0, "(currency)", "USD", "none", "", "", null),
    mkRow("Cash USD Bank B",    "cash", 0, "(currency)", "USD", "none", "", "", null),
    mkRow("USDT Exchange A",    "crypto", 0, "coin", "USD", "coingecko", "tether", "", null),
    mkRow("Bitcoin Wallet A",   "crypto", 0, "coin", "USD", "coingecko", "bitcoin", "", null),
    mkRow("Bitcoin Wallet B",   "crypto", 0, "coin", "USD", "coingecko", "bitcoin", "", null),
    mkRow("Physical Gold",      "gold", 0, "gram", "USD", "gold_spot", "gold", "", null),
    mkRow("Fill in",            "other", 0, "unit", "USD", "manual", "", "", null),
    mkRow("Fill in",            "other", 0, "unit", "USD", "manual", "", "", null),
    mkRow("Fill in",            "other", 0, "unit", "USD", "manual", "", "", null),
  ]);

  function deepMerge(target, source){
    if(typeof source !== "object" || source === null) return target;
    const out = Array.isArray(target) ? target.slice() : { ...target };
    for(const k of Object.keys(source)){
      const sv = source[k];
      const tv = out[k];
      if(Array.isArray(sv)) out[k] = sv;
      else if(typeof sv === "object" && sv !== null && typeof tv === "object" && tv !== null && !Array.isArray(tv)){
        out[k] = deepMerge(tv, sv);
      } else out[k] = sv;
    }
    return out;
  }

  function save(){
    const payload = {
      baseCcy: state.baseCcy,
      otherCcy: state.otherCcy,
      rows: state.rows,
      scenarioId: state.scenarioId,
      horizonYears: state.horizonYears,
      viewYear: state.viewYear,
      scenarioDefaults
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        const parsed = JSON.parse(raw);
        state = deepMerge(state, parsed);
        if(parsed.scenarioDefaults) scenarioDefaults = parsed.scenarioDefaults;
      }
    }catch(e){}

    if(!Array.isArray(state.rows) || state.rows.length === 0){
      state.rows = defaultRows();
    }

    state.rows = state.rows.map(r => ({
      id: r.id || randId(),
      name: r.name ?? "Asset",
      category: Categories.includes(r.category) ? r.category : "other",
      units: Number(r.units)||0,
      unit: r.unit || "unit",
      amountCcy: r.amountCcy || "USD",
      source: PriceSource.includes(r.source) ? r.source : "manual",
      sourceId: r.sourceId || "",
      manualUsd: (r.manualUsd === "" || r.manualUsd === null || typeof r.manualUsd === "undefined") ? "" : Number(r.manualUsd),
      color: (r.color && typeof r.color === "string") ? r.color : pickNextColor(),
      ratesOverride: r.ratesOverride || {}
    }));
  }

  function fmtMoney(n, ccy){
    if(!isFinite(n)) n = 0;
    try{
      return new Intl.NumberFormat(undefined, { style:"currency", currency: ccy, maximumFractionDigits: (ccy==="IDR"?0:2) }).format(n);
    }catch{
      return `${ccy} ${n.toFixed(ccy==="IDR"?0:2)}`;
    }
  }

  function nowStr(){ return new Date().toLocaleString(); }

  // DOM refs
  const assetTbody = el("assetTbody");
  const baseCcySel = el("baseCcy");
  const otherCcySel = el("otherCcy");
  const refreshBtn = el("refreshBtn");
  const addRowBtn = el("addRowBtn");
  const fillDefaultsBtn = el("fillDefaultsBtn");
  const resetBtn = el("resetBtn");
  const exportBtn = el("exportBtn");
  const importBtn = el("importBtn");
  const fileInput = el("fileInput");
  const downloadCsvBtn = el("downloadCsvBtn");

  const totalUSD = el("totalUSD");
  const totalIDR = el("totalIDR");
  const totalOther = el("totalOther");
  const lastRefresh = el("lastRefresh");

  const fxDot = el("fxDot"), fxStatus = el("fxStatus");
  const cgDot = el("cgDot"), cgStatus = el("cgStatus");
  const goldDot = el("goldDot"), goldStatus = el("goldStatus");

  const allocYearSel = el("allocYear");
  const allocNote = el("allocNote");

  const horizonYearsSel = el("horizonYears");
  const scenarioBtns = el("scenarioBtns");
  const viewYearRange = el("viewYearRange");
  const viewYearLabel = el("viewYearLabel");
  const openScenarioLink = el("openScenarioLink");

  const rateUsdIdr = el("rateUsdIdr");
  const rateBtcUsd = el("rateBtcUsd");
  const rateGoldUsdOz = el("rateGoldUsdOz");
  const ratesUpdated = el("ratesUpdated");

  const scenarioModalBg = el("scenarioModalBg");
  const scenarioDefaultsBody = el("scenarioDefaultsBody");
  const scenarioCloseBtn = el("scenarioCloseBtn");
  const scenarioSaveBtn = el("scenarioSaveBtn");
  const scenariosBtn = el("scenariosBtn");

  const rowRatesModalBg = el("rowRatesModalBg");
  const rowRatesTitle = el("rowRatesTitle");
  const rowRatesBody = el("rowRatesBody");
  const rowRatesCloseBtn = el("rowRatesCloseBtn");
  const rowRatesSaveBtn = el("rowRatesSaveBtn");
  let editingRowId = null;

  const pieCtx = el("pieChart");
  const projCtx = el("projChart");
  let pieChart = null;
  let projChart = null;

  function setDot(dotEl, ok){
    dotEl.classList.remove("good","bad");
    dotEl.classList.add(ok ? "good" : "bad");
  }

  // FX + prices
  async function fetchFX(){
    const url = "https://open.er-api.com/v6/latest/USD";
    try{
      const r = await fetch(url, { cache:"no-store" });
      const j = await r.json();
      if(j && j.result === "success" && j.rates){
        state.fx = { base:"USD", rates:j.rates, at: j.time_last_update_utc || nowStr() };
        setDot(fxDot, true);
        fxStatus.textContent = `FX: OK (${state.fx.at})`;
        return true;
      }
      throw new Error("FX parse fail");
    }catch(e){
      setDot(fxDot, false);
      fxStatus.textContent = "FX: failed (using last saved if any)";
      return false;
    }
  }

  function usdToCcy(usd, ccy){
    if(!usd || !isFinite(usd)) return 0;
    if(ccy === "USD") return usd;
    const rate = state.fx?.rates?.[ccy];
    if(!rate) return 0;
    return usd * rate;
  }
  function ccyToUsd(amount, ccy){
    if(!amount || !isFinite(amount)) return 0;
    if(ccy === "USD") return amount;
    const rate = state.fx?.rates?.[ccy];
    if(!rate) return 0;
    return amount / rate;
  }

  async function fetchCoinGeckoPrices(ids){
    if(!ids.length) return { ok:true, prices:{} };
    const unique = [...new Set(ids.filter(Boolean))];
    const url = `https://api.coingecko.com/api/v3/simple/price?ids=${encodeURIComponent(unique.join(","))}&vs_currencies=usd`;
    try{
      const r = await fetch(url, { cache:"no-store" });
      const j = await r.json();
      const prices = {};
      for(const id of unique){
        if(j[id] && typeof j[id].usd === "number") prices[id] = j[id].usd;
      }
      setDot(cgDot, true);
      cgStatus.textContent = `CoinGecko: OK (${unique.length} ids)`;
      return { ok:true, prices };
    }catch(e){
      setDot(cgDot, false);
      cgStatus.textContent = "CoinGecko: failed (manual/last)";
      return { ok:false, prices:{} };
    }
  }

  // Gold: metals.live (may CORS fail) + fallback to PAXG/XAUT
  async function fetchGoldSpotUSD(){
    try{
      const r = await fetch("https://api.metals.live/v1/spot/gold", { cache:"no-store" });
      if(!r.ok) throw new Error("HTTP " + r.status);
      const j = await r.json();
      const item = Array.isArray(j) ? j.find(x => Array.isArray(x) && (x[0]==="gold" || x[0]==="XAU")) : null;
      const spot = item && typeof item[1] === "number" ? item[1] : null;
      if(spot && isFinite(spot)){
        setDot(goldDot, true);
        goldStatus.textContent = `Gold: OK (USD/oz ${spot.toFixed(2)})`;
        return { ok:true, usdPerOz: spot };
      }
    }catch(e){
      // ignore
    }

    // fallback via CoinGecko proxies
    try{
      const url = "https://api.coingecko.com/api/v3/simple/price?ids=pax-gold,tether-gold&vs_currencies=usd";
      const r2 = await fetch(url, { cache:"no-store" });
      if(!r2.ok) throw new Error("HTTP " + r2.status);
      const j2 = await r2.json();
      const paxg = j2?.["pax-gold"]?.usd;
      const xaut = j2?.["tether-gold"]?.usd;
      const spot2 = (typeof paxg === "number" && isFinite(paxg)) ? paxg
                  : (typeof xaut === "number" && isFinite(xaut)) ? xaut
                  : null;

      if(spot2 && isFinite(spot2)){
        setDot(goldDot, true);
        goldStatus.textContent = `Gold: OK (proxy) (USD/oz ${spot2.toFixed(2)})`;
        return { ok:true, usdPerOz: spot2 };
      }
      throw new Error("No proxy price");
    }catch(e2){
      setDot(goldDot, false);
      goldStatus.textContent = "Gold: failed (use manual price)";
      return { ok:false, usdPerOz: null };
    }
  }

  // Value computation
  function getRowLiveUnitPriceUSD(row){
    if(row.category === "cash") return null;

    if(row.manualUsd !== "" && isFinite(Number(row.manualUsd))){
      return Number(row.manualUsd);
    }

    if(row.source === "coingecko" && row.sourceId){
      const key = String(row.sourceId).trim().toLowerCase();
      const p = state.pricesUSD[key];
      if(typeof p === "number") return p;
    }

    if(row.category === "gold" && state.pricesUSD.__gold_usd_oz){
      const usdPerOz = state.pricesUSD.__gold_usd_oz;
      if(row.unit === "troy_oz") return usdPerOz;
      return usdPerOz / 31.1034768;
    }

    return null;
  }

  function rowValueUSD(row){
    const units = Number(row.units)||0;
    if(row.category === "cash"){
      return ccyToUsd(units, row.amountCcy);
    }
    const price = getRowLiveUnitPriceUSD(row);
    if(price === null) return 0;
    return units * price;
  }

  function getAnnualRate(row, scenarioId){
    const ov = row.ratesOverride?.[scenarioId];
    if(typeof ov === "number" && isFinite(ov)) return ov;
    const d = scenarioDefaults?.[scenarioId]?.[row.category];
    if(typeof d === "number" && isFinite(d)) return d;
    return 0;
  }

  function calcTotalsForYear(year){
    const totals = { byRowUSD:{}, totalUSD:0 };
    for(const row of state.rows){
      const todayUSD = rowValueUSD(row);
      const annual = getAnnualRate(row, state.scenarioId);
      const factor = Math.pow(1 + (annual/100), year);
      const projected = todayUSD * factor;
      totals.byRowUSD[row.id] = projected;
      totals.totalUSD += projected;
    }
    return totals;
  }

  // Table rendering helpers
  function tdInput(row, key, opts={}){
    const td = document.createElement("td");
    const inp = document.createElement("input");
    inp.value = row[key] ?? "";
    inp.placeholder = opts.placeholder || "";
    if(opts.mono) inp.style.fontFamily = "var(--mono)";
    inp.oninput = () => { row[key] = inp.value; renderAll(false); save(); };
    td.appendChild(inp);
    return td;
  }

  function tdNumber(row, key, opts={}){
    const td = document.createElement("td");
    const inp = document.createElement("input");
    inp.type = "number";
    inp.value = row[key] === "" ? "" : (isFinite(row[key]) ? row[key] : 0);
    inp.placeholder = opts.placeholder || "";
    inp.step = opts.step || "any";
    if(opts.min) inp.min = opts.min;
    inp.className = "num";
    inp.oninput = () => {
      const v = inp.value;
      row[key] = (v === "" ? "" : Number(v));
      renderAll(false);
      save();
    };
    td.appendChild(inp);
    return td;
  }

  function tdSelect(row, key, options, opts={}){
    const td = document.createElement("td");
    const sel = document.createElement("select");
    for(const o of options){
      const op = document.createElement("option");
      op.value = o; op.textContent = o;
      sel.appendChild(op);
    }
    sel.value = row[key] ?? options[0];
    sel.onchange = () => {
      row[key] = sel.value;
      if(opts.onChange) opts.onChange(sel.value);
      renderAll(false);
      save();
    };
    td.appendChild(sel);
    return td;
  }

  function tdCcy(row, key){
    const td = document.createElement("td");
    const sel = document.createElement("select");
    const fallback = ["USD","IDR","EUR","SGD","JPY","AUD","GBP"];
    const opts = state.fx?.rates ? Object.keys(state.fx.rates) : fallback;
    const preferred = ["USD","IDR","EUR","SGD","JPY","AUD","GBP"];
    const set = new Set(opts);
    const ordered = [...preferred.filter(x => set.has(x)), ...opts.filter(x => !preferred.includes(x)).sort()].slice(0, 120);
    for(const c of ordered){
      const op = document.createElement("option");
      op.value = c; op.textContent = c;
      sel.appendChild(op);
    }
    sel.value = row[key] || "USD";
    sel.onchange = () => { row[key] = sel.value; renderAll(false); save(); };
    td.appendChild(sel);
    return td;
  }

  function tdText(text, right=false){
    const td = document.createElement("td");
    td.className = right ? "right num" : "num";
    td.textContent = text;
    return td;
  }

  function renderTable(){
    assetTbody.innerHTML = "";
    for(const row of state.rows){
      const tr = document.createElement("tr");

      tr.appendChild(tdInput(row, "name", { placeholder:"Asset name" }));

      tr.appendChild(tdSelect(row, "category", Categories, {
        onChange: (val) => {
          row.unit = (Units[val] && Units[val][0]) ? Units[val][0] : "unit";
          if(val === "cash"){
            row.source = "none";
            row.sourceId = "";
            row.manualUsd = "";
          } else {
            if(row.source === "none") row.source = "manual";
          }
          renderAll();
          save();
        }
      }));

      tr.appendChild(tdNumber(row, "units", { step:"any", min:"0" }));

      const unitOptions = Units[row.category] || ["unit"];
      tr.appendChild(tdSelect(row, "unit", unitOptions));

      tr.appendChild(tdCcy(row, "amountCcy"));

      const sourceOptions = (row.category === "cash")
        ? ["none"]
        : (row.category === "gold")
          ? ["gold_spot","manual","none","coingecko"]
          : ["coingecko","manual","none"];

      tr.appendChild(tdSelect(row, "source", sourceOptions));

      tr.appendChild(tdInput(row, "sourceId", { placeholder: row.source === "coingecko" ? "bitcoin / tether" : "ticker/id", mono:true }));
      tr.appendChild(tdNumber(row, "manualUsd", { placeholder: "(optional)", step:"any", min:"0" }));

      const tdColor = document.createElement("td");
      const c = document.createElement("input");
      c.type = "color";
      c.className = "colorbox";
      c.value = row.color || pickNextColor();
      c.oninput = () => { row.color = c.value; renderAll(false); save(); };
      tdColor.appendChild(c);
      tr.appendChild(tdColor);

      const vUSD = rowValueUSD(row);
      const vIDR = usdToCcy(vUSD, "IDR");
      const vOther = usdToCcy(vUSD, state.otherCcy);

      tr.appendChild(tdText(fmtMoney(vUSD, "USD"), true));
      tr.appendChild(tdText(fmtMoney(vIDR, "IDR"), true));
      tr.appendChild(tdText(fmtMoney(vOther, state.otherCcy), true));

      const tdA = document.createElement("td");
      tdA.className = "right";

      const bRates = document.createElement("button");
      bRates.textContent = "Rates";
      bRates.style.boxShadow = "none";
      bRates.style.padding = "6px 9px";
      bRates.onclick = () => openRowRates(row.id);

      const bDel = document.createElement("button");
      bDel.textContent = "Delete";
      bDel.className = "danger";
      bDel.style.boxShadow = "none";
      bDel.style.padding = "6px 9px";
      bDel.onclick = () => {
        state.rows = state.rows.filter(r => r.id !== row.id);
        renderAll();
        save();
      };

      tdA.appendChild(bRates);
      tdA.appendChild(document.createTextNode(" "));
      tdA.appendChild(bDel);
      tr.appendChild(tdA);

      assetTbody.appendChild(tr);
    }
  }

  // Charts
  function renderPie(year){
    const totals = calcTotalsForYear(year);

    const entries = state.rows.map(r => ({
      name: r.name || "Asset",
      usd: totals.byRowUSD[r.id] || 0,
      color: r.color || "#999999"
    })).filter(x => x.usd > 0.0000001);

    const labels = entries.map(x => x.name);
    const data = entries.map(x => x.usd);
    const colors = entries.map(x => x.color);

    const total = data.reduce((a,b)=>a+b,0);
    allocNote.textContent = (year === 0)
      ? `Allocation based on current values. Total: ${fmtMoney(total, "USD")}`
      : `Allocation projected at year ${year} (${ScenarioList.find(s=>s.id===state.scenarioId)?.label || state.scenarioId}). Total: ${fmtMoney(total, "USD")}`;

    if(!pieChart){
      pieChart = new Chart(pieCtx, {
        type: "pie",
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: colors,
            borderColor: "#E6F1F3",
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom", labels: { boxWidth: 12, color: "#E6F1F3" } },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = Number(ctx.parsed || 0);
                  const dataArr = ctx.chart?.data?.datasets?.[0]?.data || [];
                  const totalNow = dataArr.reduce((a,b)=>a + (Number(b)||0), 0);
                  const pct = totalNow ? (v / totalNow * 100) : 0;
                  return ` ${ctx.label}: ${fmtMoney(v, "USD")} (${pct.toFixed(2)}%)`;
                }
              }
            }
          }
        }
      });
    } else {
      pieChart.data.labels = labels;
      pieChart.data.datasets[0].data = data;
      pieChart.data.datasets[0].backgroundColor = colors;
      pieChart.update();
    }
  }

  function renderProjection(){
    const horizon = state.horizonYears;
    const years = Array.from({length: horizon+1}, (_,i)=>i);

    const totalsByYear = years.map(y => calcTotalsForYear(y).totalUSD);

    const buckets = { cash: years.map(()=>0), crypto: years.map(()=>0), gold: years.map(()=>0), stock: years.map(()=>0), other: years.map(()=>0) };

    for(let y=0; y<=horizon; y++){
      const byRow = calcTotalsForYear(y).byRowUSD;
      for(const row of state.rows){
        const v = byRow[row.id] || 0;
        (buckets[row.category] || buckets.other)[y] += v;
      }
    }

    const datasets = [
      { label:"Total", data: totalsByYear, borderWidth: 2, tension: .22 },
      { label:"Crypto", data: buckets.crypto, borderWidth: 1.8, tension: .22 },
      { label:"Gold", data: buckets.gold, borderWidth: 1.8, tension: .22 },
      { label:"Cash", data: buckets.cash, borderWidth: 1.8, tension: .22 },
    ];

    if(!projChart){
      projChart = new Chart(projCtx, {
        type:"line",
        data:{ labels: years.map(y => `Year ${y}`), datasets },
        options:{
          responsive:true,
          scales:{ y: { ticks: { callback: (v) => fmtMoney(v, "USD") } } },
          plugins:{
            legend:{ position:"bottom", labels:{ color:"#E6F1F3" } },
            tooltip:{ callbacks:{ label: (ctx) => `${ctx.dataset.label}: ${fmtMoney(ctx.parsed.y, "USD")}` } }
          }
        }
      });
    } else {
      projChart.data.labels = years.map(y => `Year ${y}`);
      projChart.data.datasets = datasets;
      projChart.update();
    }
  }

  // Live rates bar
  function renderRatesBar(){
    const idrRate = state.fx?.rates?.IDR;
    rateUsdIdr.textContent = idrRate ? idrRate.toLocaleString(undefined, { maximumFractionDigits: 2 }) : "—";

    const btcUsd = state.pricesUSD?.bitcoin;
    rateBtcUsd.textContent = (btcUsd && isFinite(btcUsd))
      ? new Intl.NumberFormat(undefined, { style:"currency", currency:"USD", maximumFractionDigits: 0 }).format(btcUsd)
      : "—";

    const usdPerOz = state.pricesUSD?.__gold_usd_oz;
    rateGoldUsdOz.textContent = (usdPerOz && isFinite(usdPerOz))
      ? new Intl.NumberFormat(undefined, { style:"currency", currency:"USD", maximumFractionDigits: 2 }).format(usdPerOz)
      : "—";

    ratesUpdated.textContent = "Rates updated: " + (state.lastRefresh || "—");
  }

  // Scenarios UI
  function renderScenarioButtons(){
    scenarioBtns.innerHTML = "";
    for(const s of ScenarioList){
      const b = document.createElement("button");
      b.textContent = s.label;
      b.className = (state.scenarioId === s.id) ? "active" : "";
      b.onclick = () => { state.scenarioId = s.id; renderAll(); save(); };
      scenarioBtns.appendChild(b);
    }
  }

  function renderYearSelects(){
    allocYearSel.innerHTML = "";
    for(let y=0; y<=state.horizonYears; y++){
      const op = document.createElement("option");
      op.value = String(y);
      op.textContent = `Year ${y}`;
      allocYearSel.appendChild(op);
    }
    allocYearSel.value = String(Math.min(state.viewYear, state.horizonYears));

    horizonYearsSel.innerHTML = "";
    for(const y of [1,2,3,5,7,10,15,20,30]){
      const op = document.createElement("option");
      op.value = String(y);
      op.textContent = `${y} years`;
      horizonYearsSel.appendChild(op);
    }
    horizonYearsSel.value = String(state.horizonYears);

    viewYearRange.max = String(state.horizonYears);
    viewYearRange.value = String(Math.min(state.viewYear, state.horizonYears));
    viewYearLabel.textContent = viewYearRange.value;
  }

  function openScenarioModal(){
    scenarioDefaultsBody.innerHTML = "";
    for(const s of ScenarioList){
      const tr = document.createElement("tr");
      const tdName = document.createElement("td");
      tdName.textContent = s.label;
      tr.appendChild(tdName);

      for(const cat of Categories){
        const td = document.createElement("td");
        const inp = document.createElement("input");
        inp.type = "number";
        inp.step = "any";
        inp.value = scenarioDefaults?.[s.id]?.[cat] ?? 0;
        inp.dataset.scenario = s.id;
        inp.dataset.cat = cat;
        inp.className = "num";
        td.appendChild(inp);
        tr.appendChild(td);
      }
      scenarioDefaultsBody.appendChild(tr);
    }
    scenarioModalBg.style.display = "flex";
  }
  function closeScenarioModal(){ scenarioModalBg.style.display = "none"; }
  function saveScenarioModal(){
    const inputs = scenarioDefaultsBody.querySelectorAll("input[type=number]");
    for(const inp of inputs){
      const s = inp.dataset.scenario;
      const cat = inp.dataset.cat;
      const v = Number(inp.value);
      if(!scenarioDefaults[s]) scenarioDefaults[s] = {};
      scenarioDefaults[s][cat] = isFinite(v) ? v : 0;
    }
    closeScenarioModal();
    renderAll();
    save();
  }

  function openRowRates(rowId){
    const row = state.rows.find(r => r.id === rowId);
    if(!row) return;
    editingRowId = rowId;
    rowRatesTitle.textContent = `Asset-specific rates: ${row.name || "Asset"}`;
    rowRatesBody.innerHTML = "";

    for(const s of ScenarioList){
      const tr = document.createElement("tr");

      const tdS = document.createElement("td");
      tdS.textContent = s.label;
      tr.appendChild(tdS);

      const tdInp = document.createElement("td");
      const inp = document.createElement("input");
      inp.type = "number";
      inp.step = "any";
      inp.placeholder = "(use default)";
      const existing = row.ratesOverride?.[s.id];
      inp.value = (typeof existing === "number" && isFinite(existing)) ? existing : "";
      inp.dataset.scenario = s.id;
      inp.className = "num";
      tdInp.appendChild(inp);
      tr.appendChild(tdInp);

      const tdEx = document.createElement("td");
      const d = scenarioDefaults?.[s.id]?.[row.category] ?? 0;
      tdEx.innerHTML = `<span class="small">Default for <b>${row.category}</b>: ${d}%</span>`;
      tr.appendChild(tdEx);

      rowRatesBody.appendChild(tr);
    }

    rowRatesModalBg.style.display = "flex";
  }
  function closeRowRates(){ rowRatesModalBg.style.display = "none"; editingRowId = null; }
  function saveRowRates(){
    if(!editingRowId) return;
    const row = state.rows.find(r => r.id === editingRowId);
    if(!row) return;

    const inputs = rowRatesBody.querySelectorAll("input[type=number]");
    for(const inp of inputs){
      const sid = inp.dataset.scenario;
      const raw = inp.value;
      if(raw === ""){
        delete row.ratesOverride[sid];
      } else {
        const v = Number(raw);
        row.ratesOverride[sid] = isFinite(v) ? v : 0;
      }
    }
    closeRowRates();
    renderAll();
    save();
  }

  // Totals + render master
  function renderTotals(){
    const t = calcTotalsForYear(0).totalUSD;
    totalUSD.textContent = fmtMoney(t, "USD");
    totalIDR.textContent = fmtMoney(usdToCcy(t, "IDR"), "IDR");
    totalOther.textContent = fmtMoney(usdToCcy(t, state.otherCcy), state.otherCcy);
    lastRefresh.textContent = state.lastRefresh || "—";
  }

  function renderAll(rebuildTable=true){
    if(rebuildTable) renderTable();
    renderTotals();
    renderScenarioButtons();
    renderYearSelects();

    const allocYear = Number(allocYearSel.value || 0);
    renderPie(allocYear);
    renderProjection();
    renderRatesBar();
  }

  // Export / Import / CSV
  function exportJSON(){
    const payload = {
      exportedAt: nowStr(),
      version: 2,
      state: {
        baseCcy: state.baseCcy,
        otherCcy: state.otherCcy,
        rows: state.rows,
        scenarioId: state.scenarioId,
        horizonYears: state.horizonYears,
        viewYear: state.viewYear,
      },
      scenarioDefaults
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "portfolio-tracker-export.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  function importJSONFile(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const j = JSON.parse(reader.result);
        if(j.state) state = deepMerge(state, j.state);
        if(j.scenarioDefaults) scenarioDefaults = j.scenarioDefaults;

        state.rows = (state.rows||[]).map(r => ({ ...r, color: r.color || pickNextColor() }));
        save();
        renderAll();
      }catch(e){
        alert("Invalid JSON file.");
      }
    };
    reader.readAsText(file);
  }

  function downloadCSV(){
    const header = ["name","category","units","unit","amountCcy","source","sourceId","manualUsd","color","valueUsd"];
    const rows = state.rows.map(r => {
      const v = rowValueUSD(r);
      return [r.name,r.category,r.units,r.unit,r.amountCcy,r.source,r.sourceId,r.manualUsd,r.color,v]
        .map(x => `"${String(x ?? "").replaceAll('"','""')}"`).join(",");
    });
    const csv = header.join(",") + "\n" + rows.join("\n");
    const blob = new Blob([csv], { type:"text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "portfolio-tracker.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  // ✅ Price refresh pipeline (FIXED & CLEAN)
  async function refreshAllPrices(){
    await fetchFX();

    // Always fetch BTC for footer
    const ids = ["bitcoin"];

    // Add all coingecko row ids (normalized lowercase)
    state.rows
      .filter(r => r.source === "coingecko" && r.sourceId)
      .forEach(r => {
        const id = String(r.sourceId).trim().toLowerCase();
        if(id) ids.push(id);
      });

    // If gold_spot exists, also fetch proxy gold tokens
    const hasGoldRow = state.rows.some(r => r.category === "gold" && r.source === "gold_spot");
    if(hasGoldRow){
      ids.push("pax-gold", "tether-gold");
    }

    const uniqueIds = [...new Set(ids)];

    // Fetch CoinGecko USD prices
    const cg = await fetchCoinGeckoPrices(uniqueIds);
    for(const [k, v] of Object.entries(cg.prices)){
      state.pricesUSD[k] = v;
    }

    // Fetch gold (metals.live -> fallback proxy)
    if(hasGoldRow){
      const gold = await fetchGoldSpotUSD();
      if(gold.ok && gold.usdPerOz){
        state.pricesUSD.__gold_usd_oz = gold.usdPerOz;
      } else {
        // final fallback using already-fetched proxy tokens
        const paxg = state.pricesUSD["pax-gold"];
        const xaut = state.pricesUSD["tether-gold"];
        const proxy = (typeof paxg === "number" && isFinite(paxg)) ? paxg
                    : (typeof xaut === "number" && isFinite(xaut)) ? xaut
                    : null;
        if(proxy) state.pricesUSD.__gold_usd_oz = proxy;
      }
    }

    state.lastRefresh = nowStr();
    save();
    renderAll();
  }

  // Actions
  function addRow(){
    state.rows.push(mkRow("New Asset", "other", 0, "unit", "USD", "manual", "", "", null));
    renderAll();
    save();
  }

  function loadDefaults(){
    state.rows = defaultRows();
    renderAll();
    save();
  }

  function resetAll(){
    if(!confirm("Reset everything? This clears local data.")) return;
    localStorage.removeItem(STORAGE_KEY);
    state.rows = defaultRows();
    state.fx = { base:"USD", rates:{}, at:null };
    state.pricesUSD = {};
    state.lastRefresh = null;
    save();
    renderAll();
  }

  // Wire events
  baseCcySel.onchange = () => { state.baseCcy = baseCcySel.value; save(); renderAll(); };
  otherCcySel.onchange = () => { state.otherCcy = otherCcySel.value; save(); renderAll(); };

  refreshBtn.onclick = refreshAllPrices;
  addRowBtn.onclick = addRow;
  fillDefaultsBtn.onclick = loadDefaults;
  resetBtn.onclick = resetAll;

  exportBtn.onclick = exportJSON;
  importBtn.onclick = () => fileInput.click();
  fileInput.onchange = () => {
    const f = fileInput.files && fileInput.files[0];
    if(f) importJSONFile(f);
    fileInput.value = "";
  };
  downloadCsvBtn.onclick = downloadCSV;

  horizonYearsSel.onchange = () => {
    state.horizonYears = Number(horizonYearsSel.value) || 5;
    state.viewYear = Math.min(state.viewYear, state.horizonYears);
    save();
    renderAll();
  };

  allocYearSel.onchange = () => { renderPie(Number(allocYearSel.value||0)); };

  viewYearRange.oninput = () => {
    const y = Number(viewYearRange.value) || 0;
    state.viewYear = y;
    allocYearSel.value = String(y);
    viewYearLabel.textContent = String(y);
    renderPie(y);
    save();
  };

  scenariosBtn.onclick = openScenarioModal;
  openScenarioLink.onclick = openScenarioModal;
  scenarioCloseBtn.onclick = closeScenarioModal;
  scenarioSaveBtn.onclick = saveScenarioModal;
  scenarioModalBg.onclick = (e) => { if(e.target === scenarioModalBg) closeScenarioModal(); };

  rowRatesCloseBtn.onclick = closeRowRates;
  rowRatesSaveBtn.onclick = saveRowRates;
  rowRatesModalBg.onclick = (e) => { if(e.target === rowRatesModalBg) closeRowRates(); };

  // Init
  load();
  baseCcySel.value = state.baseCcy || "USD";
  otherCcySel.value = state.otherCcy || "IDR";

  renderAll(true);
  refreshAllPrices();
})();
</script>
</body>
</html>
